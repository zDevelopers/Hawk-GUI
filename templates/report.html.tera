<!DOCTYPE html>

{%- import "__macros__" as hawk -%}

{% if report.settings.summary.enabled %}
    {% set default_tab = 'summary' %}
{% elif report.settings.damages.enabled %}
    {% set default_tab = 'damages' %}
{% else %}
    {% set default_tab = 'players' %}
{% endif %}

<html lang="fr">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, user-scalable=yes" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />

        <title>{{ report.title | minecraft | striptags }} – Récapitulatif de partie</title>

        <link rel="stylesheet" href="/static/css/hawk.min.css" />
        <link rel="icon" href="/static/images/apple-golden.png" />
    </head>

    <body>
        <header class="hero">
            <div class="hero-body">
                <div class="container">
                    <div class="columns is-vcentered">
                        <div class="column is-7">
                            <h1 class="title">
                                {{ report.title | minecraft }}
                            </h1>
                            <h2 class="subtitle">
                                {% if report.settings.players_count %}
                                    {{ report.players | length }} joueurs
                                {% endif %}

                                {% if report.settings.players_count and report.settings.date %} - {% endif %}

                                {% if report.settings.date %}
                                    {{ report.date | date(format='%d %B %Y') }}
                                {% endif %}
                            </h2>
                        </div>
                        <div class="column is-5 has-text-right uhc-winners">
                            {% if report.settings.winners and report.winners %}
                                <aside class="chest">
                                    <h3 class="chest-title is-all-caps">Les gagnants</h3>
                                    <ul>
                                        {% for winner in report.winners | sort(attribute="name") %}
                                            <li>
                                                <figure class="image minecraft-tooltip" data-tooltip="{{ winner.name }}">
                                                    <img src="{{ head(uuid=winner.uuid, size=80) }}" alt="{{ winner.name }}" />
                                                </figure>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </aside>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="hero-foot">
                <nav class="tabs is-boxed is-fullwidth">
                    <div class="container">
                        <ul>
                            {% if report.settings.summary.enabled %}
                                <li {% if default_tab == 'summary' %}class="is-active"{% endif %}>
                                    <a class="js-tab-link" href="#summary">Récapitulatif</a>
                                </li>
                            {% endif %}

                            {% if report.settings.damages.enabled %}
                                <li {% if default_tab == 'damages' %}class="is-active"{% endif %}>
                                    <a class="js-tab-link" href="#damages">Dégâts et régénérations</a>
                                </li>
                            {% endif %}

                            {% if report.settings.players.enabled %}
                                <li {% if default_tab == 'players' %}class="is-active"{% endif %}>
                                    <a class="js-tab-link" href="#players">Joueurs et statistiques</a>
                                </li>
                            {% endif %}
                        </ul>
                    </div>
                </nav>
            </div>
        </header>

        {% if report.settings.summary.enabled %}
        <section class="section js-tab-section {% if default_tab != 'summary' %}is-hidden{% endif %}" id="summary">
            <div class="container">
                <div class="columns">
                    {% if report.settings.summary.history %}
                        <div class="column">
                        <article class="chest">
                            <h3 class="chest-title">Déroulement de la partie</h3>

                            <div class="chest-inner is-sandstone">
                                {% if report.events %}
                                    <ul class="minecraft-timeline">
                                        {% for event in report.events %}
                                        <li class="timeline-item is-{{ event['type'] | slugify | replace(from='_', to='-') }}-event">
                                            <div class="timeline-item-header">
                                                <figure aria-hidden="true">
                                                    {% if event.icon.uuid is defined %}
                                                        <img src="{{ head(uuid=event.icon.uuid, size=32) }}" alt="" class="is-head" />
                                                    {% elif event.icon.icon_id is defined %}
                                                        <span class="i-{{ event.icon.icon_id }}"></span>
                                                    {% elif event.icon.url is defined %}
                                                        <img src="{{ event.icon.url }}" alt="" />
                                                    {% endif %}
                                                </figure>
                                                <h4>
                                                    {{ event.title }}
                                                    <time datetime="{{ event.date }}" title="{{ event.date | date(format='%Hh%M') }}">{{ event.since_beginning | duration }}</time>
                                                </h4>
                                                <div class="is-clearfix"></div>
                                            </div>
                                            {% if event.description is defined %}
                                                <div class="timeline-item-details">
                                                    {{ event.description | minecraft | striptags }}
                                                </div>
                                            {% endif %}
                                        </li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                            </div>
                        </article>
                    </div>
                    {% endif %}

                    {% if report.settings.summary.players %}
                        <div class="column">
                            <article class="chest teams-list">
                                <h3 class="chest-title">
                                    {%- if not report.settings.summary.teams or not report.teams -%}
                                        Les joueurs
                                    {%- else -%}
                                        Les équipes
                                    {%- endif -%}
                                </h3>

                                {% if not report.settings.summary.teams or not report.teams %}
                                    <ul class="players-list">
                                        {% for player in report.players %}
                                            <li>
                                                {{ hawk::player(player=player, large=true) }}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    {% for team in report.teams %}
                                        <h4 class="team-{{ team.color | css_class }} has-text-colored has-outline">{{ team.name }}</h4>

                                        <ul class="players-list">
                                        {% for player in team.players %}
                                            <li>
                                                {{ hawk::player(player=player, large=true) }}
                                            </li>
                                        {% endfor %}
                                        </ul>
                                    {% endfor %}

                                    {% if report.has_players_without_team %}
                                        <h4 class="team-dark-gray has-text-colored has-outline">Joueurs sans équipe</h4>

                                        <ul class="players-list">
                                            {% for player in report.players %}
                                                {% if not player.team %}
                                                    <li>
                                                        {{ hawk::player(player=player, large=true) }}
                                                    </li>
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
                                    {% endif %}
                                {% endif %}
                            </article>
                        </div>
                    {% endif %}
                </div>
            </div>
        </section>
        {% endif %}

        {% if report.settings.damages.enabled %}
        <section class="section js-tab-section {% if default_tab != 'damages' %}is-hidden{% endif %}" id="damages">
            <div class="container">

                {% if report.settings.damages.damages_per_players %}
                <article class="chest">
                    <h3 class="chest-title">Joueurs</h3>

                    {% for player in report.players | sort(attribute="name") %}
                        {% set aggreg = report.aggregates.players_damages[player.uuid] %}
                        <div class="chest-inner damages-report">
                            <div class="columns">
                                <div class="column damages-report-player-parent">
                                    <div class="damages-report-player">
                                        <figure class="player-head{% if player.team and report.settings.summary.teams %} is-{{ player.color | css_class }}{% endif %}">
                                            <img src="{{ head(uuid=player.uuid, size=90) }}" alt="{{ player.name }}"{% if player.tag_line_details %} aria-describedby="hawk-tooltip-player-tags-{{ player.uuid }}"{% endif %} />
                                            <figcaption>
                                                <span class="name"{% if player.tag_line_details %} aria-describedby="hawk-tooltip-player-tags-{{ player.uuid }}"{% endif %}>{{ player.name }}</span>

                                                {% if player.tag_line %}
                                                    <span class="tag-line"{% if player.tag_line_details %} title="{{ player.tag_line_details }}" aria-describedby="hawk-tooltip-player-tags-{{ player.uuid }}" data-replace-title{% endif %}>{{ player.tag_line }}</span>
                                                {% endif %}

                                                {% if player.tag_line_secondary %}
                                                    <span class="tag-line-secondary"{% if player.tag_line_details %} title="{{ player.tag_line_details }}" aria-describedby="hawk-tooltip-player-tags-{{ player.uuid }}" data-replace-title{% endif %}>{{ player.tag_line_secondary }}</span>
                                                {% endif %}
                                            </figcaption>
                                        </figure>

                                        {% if player.tag_line_details %}
                                            <div class="hawk-tooltip" id="hawk-tooltip-player-tags-{{ player.uuid }}">
                                                {{ hawk::player_tooltip(player=player) }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="column damages-report-alterations-parent">
                                    <div class="damages-report-alterations">
                                        <h4><strong>{{ aggreg.damages_taken_total }}</strong> dégâts reçus</h4>

                                        <ul>
                                            {% for damage in aggreg.damages_taken %}
                                                <li title="
                                                        {%- if damage.cause == 'PLAYER' %}{{ damage.damager.name }}{% else %}{{ damage.cause | name }} {% endif -%}
                                                        {%- if damage.weapon != 'FISTS' and damage.weapon != 'UNKNOWN' %} avec {{ damage.weapon | name | lower }} {% endif -%}
                                                        : -{{ damage.damage }} point(s) de vie{% if damage.lethal %} (mortel){% endif %}" data-replace-title>
                                                    <span class="weapon {% if damage.weapon != 'UNKNOWN' and damage.weapon != 'FISTS' %}i-{{ damage.weapon | icon }}{% endif %}" aria-describedby="hawk-tooltip-weapon-damages-received-{{ player.uuid }}-{{ loop.index0 }}"></span>

                                                    <span aria-describedby="hawk-tooltip-source-damages-received-{{ player.uuid }}-{{ loop.index0 }}">
                                                        {% if damage.cause == 'PLAYER' and damage.damager %}
                                                            <span class="source">
                                                                <img src="{{ head(uuid=damage.damager.uuid, size=20) }}" alt="{{ damage.damager.name }}" />
                                                            </span>
                                                        {% else %}
                                                            <span class="source i-{{ damage.cause | icon }}"></span>
                                                        {% endif %}
                                                        {{ hawk::hearts(hearts=damage.damage, lethal=damage.lethal) }}
                                                    </span>

                                                    <div class="hawk-tooltip" id="hawk-tooltip-weapon-damages-received-{{ player.uuid }}-{{ loop.index0 }}">
                                                        {{ hawk::weapon_tooltip(weapon=damage.weapon, weapon_name=damage.weapon_name, weapon_enchantments=damage.weapon_enchantments) }}
                                                    </div>

                                                    <div class="hawk-tooltip" id="hawk-tooltip-source-damages-received-{{ player.uuid }}-{{ loop.index0 }}">
                                                        {{ hawk::damage_tooltip(damage=damage) }}
                                                    </div>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>

                                <div class="column damages-report-alterations-parent">
                                    <div class="damages-report-alterations">
                                        <h4><strong>{{ aggreg.damages_caused_total }}</strong> dégâts engendrés</h4>

                                        <ul>
                                            {% for damage in aggreg.damages_caused %}
                                                <li title="
                                                        {%- if damage.cause == 'PLAYER' %}{{ damage.damager.name }}{% else %}{{ damage.cause | name }}{% endif -%}
                                                        {%- if damage.weapon != 'FISTS' and damage.weapon != 'UNKNOWN' %} avec {{ damage.weapon | name | lower }} {% endif -%}
                                                        : -{{ damage.damage }} point(s) de vie{% if damage.lethal %} (mortel){% endif %}" data-replace-title>
                                                    <span class="weapon {% if damage.weapon != 'UNKNOWN' and damage.weapon != 'FISTS' %}i-{{ damage.weapon | icon }}{% endif %}"  aria-describedby="hawk-tooltip-weapon-damages-caused-{{ player.uuid }}-{{ loop.index0 }}"></span>
                                                    <span class="source" aria-describedby="hawk-tooltip-source-damages-caused-{{ player.uuid }}-{{ loop.index0 }}">
                                                        <img src="{{ head(uuid=damage.damagee.uuid, size=20) }}" alt="{{ damage.damagee.name }}" />
                                                    </span>
                                                    {{ hawk::hearts(hearts=damage.damage, lethal=damage.lethal) }}
                                                </li>

                                                <div class="hawk-tooltip" id="hawk-tooltip-weapon-damages-caused-{{ player.uuid }}-{{ loop.index0 }}">
                                                    {{ hawk::weapon_tooltip(weapon=damage.weapon, weapon_name=damage.weapon_name, weapon_enchantments=damage.weapon_enchantments) }}
                                                </div>

                                                <div class="hawk-tooltip" id="hawk-tooltip-source-damages-caused-{{ player.uuid }}-{{ loop.index0 }}">
                                                    {{ hawk::damage_tooltip(damage=damage) }}
                                                </div>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>

                                <div class="column damages-report-alterations-parent is-health">
                                    <div class="damages-report-alterations">
                                        <h4><strong>{{ aggreg.heals_total }}</strong> vie régénérée</h4>

                                        <ul>
                                            {% for heal in aggreg.heals %}
                                                <li title="{{ heal.cause | name }} : +{{ heal.heal }} point(s) de vie" data-replace-title>
                                                    <span class="source i-{{ heal.cause | icon }}" aria-describedby="hawk-tooltip-heal-{{ player.uuid }}-{{ loop.index0 }}"></span>
                                                    {{ hawk::hearts(hearts=heal.heal) }}

                                                    <div class="hawk-tooltip" id="hawk-tooltip-heal-{{ player.uuid }}-{{ loop.index0 }}">
                                                        {{ hawk::heal_tooltip(heal=heal) }}
                                                    </div>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>

                                <div class="column damages-report-kills-parent">
                                    <div class="damages-report-kills">
                                        {% if aggreg.kills %}
                                            <h4><strong>{{ aggreg.kills | length }}</strong> joueur{{ aggreg.kills | length | pluralize }} tué{{ aggreg.kills | length | pluralize }}</h4>

                                            <ul>
                                                {% for kill in aggreg.kills %}
                                                    <li>
                                                        {{ hawk::player(player=kill) }}
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% endif %}

                                        {% if report.settings.damages.display_killer and aggreg.killed_by %}
                                            <h4 class="is-bold">Tué par</h4>

                                            <ul>
                                                <li>
                                                    {% if aggreg.killed_by.type == 'player' %}
                                                        {{ hawk::player(player=aggreg.killed_by.player) }}
                                                    {% else %}
                                                        <a href="" class="player is-fake-player">
                                                            <figure aria-hidden="true">
                                                                <span class="i-{{ aggreg.killed_by.cause | icon | replace(from='-small', to='') }} is-rounded"></span>
                                                            </figure>
                                                            <span>{{ aggreg.killed_by.cause | name }}</span>
                                                        </a>
                                                    {% endif %}
                                                </li>
                                            </ul>
                                        {% endif %}

                                        <h4 class="is-bold">Classement</h4>

                                        <p class="player-rank{% if aggreg.rank == 1 %} is-winner{% endif %}">{{ aggreg.rank }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </article>
                {% endif %}

                {% if report.settings.damages.damages_per_team %}
                <!-- TODO
                <article class="chest">
                    <h3 class="chest-title">Équipes</h3>
                </article>
                -->
                {% endif %}

                {% if report.settings.damages.damages_from_environment %}
                <article class="chest">
                    <h3 class="chest-title">Dégâts engendrés par l'environnement</h3>

                    <div class="columns">
                        <div class="column">
                            <div class="chest-inner natural-damages-report">
                                {% for cause, damage in report.aggregates.environmental_damages %}
                                    {% if cause is creature %}
                                        {% set_global had_env_creatures = true %}
                                        <div class="natural-damages-report-line">
                                            <div class="columns">
                                                <div class="column is-4 natural-damages-report-source">
                                                    <figure>
                                                        <span class="i-{{ cause | icon | replace(from='-small', to='-large') }} is-rounded"></span>
                                                        <figcaption>{{ cause | name }}</figcaption>
                                                    </figure>
                                                </div>
                                                <div class="column is-8 natural-damages-report-damages">
                                                    <h4><strong>{{ damage }}</strong> dégât{{ damage | pluralize }} engendré{{ damage| pluralize }}</h4>
                                                    {{ hawk::hearts(hearts=damage, list=true) }}
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                                {% if not had_env_creatures is defined %}
                                    <p class="chest-inner-empty">
                                        Les créatures n'ont causé aucun dégât.
                                    </p>
                                {% endif %}
                            </div>
                        </div>
                        <div class="column">
                            <div class="chest-inner natural-damages-report">
                                {% for cause, damage in report.aggregates.environmental_damages %}
                                    {% if not cause is creature %}
                                        {% set_global had_env_env = true %}
                                        <div class="natural-damages-report-line">
                                            <div class="columns">
                                                <div class="column is-4 natural-damages-report-source">
                                                    <figure>
                                                        <span class="i-{{ cause | icon | replace(from='-small', to='-large') }} is-rounded"></span>
                                                        <figcaption>{{ cause | name }}</figcaption>
                                                    </figure>
                                                </div>
                                                <div class="column is-8 natural-damages-report-damages">
                                                    <h4><strong>{{ damage }}</strong> dégât{{ damage | pluralize }} engendré{{ damage| pluralize }}</h4>
                                                    {{ hawk::hearts(hearts=damage, list=true) }}
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                                {% if not had_env_env is defined %}
                                    <p class="chest-inner-empty">
                                        Aucun dégât n'a été causé par l'environnment inanimé.
                                    </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </article>
                {% endif %}
            </div>
        </section>
        {% endif %}

        {% if report.settings.players.enabled %}
        <section class="section js-tab-section {% if default_tab != 'players' %}is-hidden{% endif %}" id="players">
        {% endif %}

        </section>

        <footer>
            <div class="content has-text-centered">
                <p>
                    Généré {% if report.settings.generator -%}
                        par <a href="{{ report.settings.generator.link }}">{{ report.settings.generator.name }}</a>
                    {%- endif %}
                    grâce à
                    <a href="/">Hawk</a>, un projet développé avec amour
                    <a href="https://github.com/zDevelopers/Hawk-GUI">en Rust</a> avec
                    <a href="https://rocket.rs">Rocket</a> par <a href="https://amaury.carrade.eu">Amaury Carrade</a>.<br />
                    Nous ne sommes pas responsables du contenu de ce site (en particulier, des pseudonymes et noms d'équipe).
                </p>
            </div>
        </footer>

        <script type="application/javascript">
            document.addEventListener("DOMContentLoaded", function() {
                const tabs = document.querySelectorAll('.js-tab-section');
                const tabs_links = document.querySelectorAll('.js-tab-link');

                tabs_links.forEach(function(element) {
                    element.addEventListener("click", function(e) {
                        e.preventDefault();
                        tabs.forEach(function(tab) { tab.classList.add('is-hidden'); });

                        let target = e.target.attributes['href'].value;
                        let tab = document.querySelector(target);

                        if (tab) {
                            tab.classList.remove('is-hidden');

                            tabs_links.forEach(function(tab_link) {
                                tab_link.parentElement.classList.remove('is-active');
                                if (tab_link.attributes['href'].value === target) {
                                    tab_link.parentElement.classList.add('is-active');
                                }
                            })
                        }
                    });
                });

                const players_links = document.querySelectorAll('a.player');

                players_links.forEach(function(element) {
                    element.addEventListener('click', function(e) {
                        e.preventDefault();
                        element.blur();
                        // TODO link to player stats tab if it's a real link
                    })
                });

                // Replaces marked titles with aria-label, because they interfere with tooltips
                document.querySelectorAll("[data-replace-title]").forEach(function(element) {
                    element.setAttribute("aria-label", element.getAttribute("title"));
                    element.setAttribute("title", "");
                });

                const real_tooltip = document.createElement("div");
                real_tooltip.classList.add("minecraft-rich-tooltip");

                document.body.appendChild(real_tooltip);

                document.querySelectorAll("[aria-describedby]").forEach(function(element) {
                    const tooltip = document.getElementById(element.getAttribute("aria-describedby"));

                    element.addEventListener('mouseover', function(e) {
                        tooltip.setAttribute("aria-hidden", "false");
                        show_tooltip(real_tooltip, tooltip);
                    });

                    element.addEventListener('mouseout', function(e) {
                        tooltip.setAttribute("aria-hidden", "true");
                        hide_tooltip(real_tooltip, tooltip);
                    });

                    element.addEventListener('mousemove', function(e) {
                        if (e.movementX && e.movementX > 20 || e.movementY && e.movementY > 20)
                            return;

                        let mouseX, mouseY;

                        if (e.offsetX) {
                            mouseX = e.offsetX;
                            mouseY = e.offsetY;
                        } else if (e.layerX) {
                            mouseX = e.layerX;
                            mouseY = e.layerY;
                        }

                        let body_bouncing_box    = document.body.getBoundingClientRect(),
                            element_bouncing_box = element.getBoundingClientRect(),
                            offset_top           = element_bouncing_box.top - body_bouncing_box.top,
                            offset_left          = element_bouncing_box.left - body_bouncing_box.left;

                        real_tooltip.style.top = (offset_top + mouseY - 4) + "px";
                        real_tooltip.style.left = (offset_left + mouseX + 8) + "px";

                    });
                });
            });

            function show_tooltip(real_tooltip, element) {
                real_tooltip.innerHTML = element.innerHTML;
                real_tooltip.classList.add("is-active");
            }

            function hide_tooltip(real_tooltip) {
                real_tooltip.innerHTML = "";
                real_tooltip.classList.remove("is-active");
            }
        </script>
    </body>
</html>
